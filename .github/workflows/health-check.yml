name: Periodic Health Check

on:
  schedule:
    # Run every 15 minutes
    - cron: "*/15 * * * *"
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  health_check:
    runs-on: ubuntu-latest
    steps:
      - name: Check Application Health
        uses: Jtalk/url-health-check-action@v4
        with:
          url: https://fullstackopen-part11.web.app/health.json
          max-attempts: 3
          retry-delay: 10s
          follow-redirect: true

      - name: Health Check Failed Notification
        uses: rjstone/discord-webhook-notify@v2
        if: failure()
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
          severity: error
          description: "ðŸš¨ Health check failed for production app"
          details: |
            **URL:** https://fullstackopen-part11.web.app/health.json
            **Status:** Failed after 3 attempts
            **Time:** ${{ github.event.repository.updated_at }}

            The application may be down or unhealthy!

            Check the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
